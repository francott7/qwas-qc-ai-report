# GWAS-QC-AI-report

*End-to-end GWAS QC + PRS pipeline with AI-generated, publication-ready reports (Hail · Python · GPT-4 · Mermaid)*

[![CI status](https://github.com/francott7/GWAS-QC-AI-report/actions/workflows/ci.yml/badge.svg)](https://github.com/francott7/GWAS-QC-AI-report/actions)
Licensed under the MIT License

---

## ✨ Why use this repo?

* **One-stop QC → PRS → Report** — from raw VCF to a polished PDF in a single pipeline.
* **AI-powered reporting** — Executive summary and recommendations are generated by GPT-4, tailored to your results.
* **Visual audit trail** — Variant flowchart is automatically rendered and embedded as a figure.
* **Reproducible & Extensible** — Modular Python scripts, container-ready, CI-tested, and fully configurable.

---

## 🗂 Repository layout

```
.
├── src/                  # Core Python and shell scripts
│   ├── 01_qc_hail.py         # Sample & variant QC (Hail)
│   ├── 02_qc_plots.py        # QC and PCA plots
│   ├── 03_clump_snps.sh      # LD clumping (PLINK)
│   ├── 04_calculate_prs.py   # PRS calculation (streaming, efficient)
│   ├── 05_analyze_prs.py     # PRS analysis, regression, plots
│   ├── 06_select_causal_snps.py # Select causal SNPs for simulation
│   ├── 07_simulate_phenotype.py # Simulate phenotype for demo/test
│   ├── 08_variant_flowchart.py  # Generate and render variant flowchart (Mermaid)
│   └── 09_report.py          # Generate AI-powered report (Jinja2 + OpenAI)
├── reports_template/     # Markdown ↔ PDF template & prompt
├── data/                 # Example chr22 VCF & toy GWAS stats
├── results/              # All pipeline outputs (metrics, plots, flowchart, reports)
├── tests/                # Pytest unit / workflow tests
├── environment.yml       # Conda definition
├── Dockerfile            # (Optional) Container build
└── README.md
```

---

## 🔧 Quick start

### 1. Clone & set up

```bash
git clone https://github.com/francott7/GWAS-QC-AI-report.git
cd GWAS-QC-AI-report
conda env create -f environment.yml
conda activate gwas-qc
```

### 2. Install Node.js and Mermaid CLI (for flowchart rendering)

- **Node.js:** https://nodejs.org/ (or `brew install node` on macOS)
- **Mermaid CLI:**
  ```sh
  sudo npm install -g @mermaid-js/mermaid-cli
  # or for local use: npm install @mermaid-js/mermaid-cli
  ```

### 3. Configure your OpenAI key

Create **`config.json`** in the project root:

```json
{ "openai_api_key": "sk-XXXXXXXXXXXXXXXX" }
```

### 4. Run the demo pipeline (step-by-step)

```bash
# 1. QC
python src/01_qc_hail.py --input data/raw/ALL.chr22.phase3_shapeit2_mvncall_integrated_v5b.20130502.genotypes.vcf.gz --output results/01_qc/qc_metrics.json

# 2. QC plots
python src/02_qc_plots.py --qc-metrics results/01_qc/qc_metrics.json --output-dir results/02_qc_plots

# 3. Clumping
bash src/03_clump_snps.sh

# 4. PRS calculation
python src/04_calculate_prs.py --input data/raw/ALL.chr22.phase3_shapeit2_mvncall_integrated_v5b.20130502.genotypes.vcf.gz --effect-sizes data/reference/effect_sizes.csv --output results/04_prs/prs_metrics.json

# 5. PRS analysis
python src/05_analyze_prs.py --prs-file results/04_prs/prs_metrics.json --qc-file results/01_qc/qc_metrics.json --output-dir results/05_analysis

# 6. Select causal SNPs (optional, for simulation)
python src/06_select_causal_snps.py --input data/reference/effect_sizes.csv --output data/processed/causal_snps.list

# 7. Simulate phenotype (optional)
python src/07_simulate_phenotype.py --causal-snps data/processed/causal_snps.list --output data/processed/simulated_phenotype.txt

# 8. Variant flowchart (auto-renders PNG)
python src/08_variant_flowchart.py --qc-metrics results/01_qc/qc_metrics.json --effect-sizes data/processed/gwas_effect_sizes_filtered_harmonized.txt --causal-snps data/processed/causal_snps.list --output results/08_variant_flowchart/variant_flowchart.mmd

# 9. Generate report (AI-powered)
python src/09_report.py --qc-metrics results/01_qc/qc_metrics.json --prs-metrics results/04_prs/prs_metrics.json --output-dir reports --template-dir reports_template
```

**Output:**
- All results, figures, and reports are saved in the `results/` and `reports/` directories.
- The final report is in both Markdown and PDF: `reports/report_<timestamp>.md` and `.pdf`.
- The variant flowchart is embedded as a figure in the report.

### One-click full pipeline

After setup, you can run the entire pipeline with:

```bash
bash run_pipeline.sh
```

All results and the final report will be in the `results/` and `reports/` directories.

---

## ⚙️ Key pipeline steps

| Step | Script | Output |
|------|--------|--------|
| 1. QC | `01_qc_hail.py` | `results/01_qc/qc_metrics.json` |
| 2. QC plots | `02_qc_plots.py` | `results/02_qc_plots/*.png` |
| 3. Clumping | `03_clump_snps.sh` | `results/03_clumping/chr22_clumped.log` |
| 4. PRS calculation | `04_calculate_prs.py` | `results/04_prs/prs_metrics.json` |
| 5. PRS analysis | `05_analyze_prs.py` | `results/05_analysis/prs_analysis_metrics.json` |
| 6. Causal SNPs | `06_select_causal_snps.py` | `data/processed/causal_snps.list` |
| 7. Simulate phenotype | `07_simulate_phenotype.py` | `data/processed/simulated_phenotype.txt` |
| 8. Flowchart | `08_variant_flowchart.py` | `results/08_variant_flowchart/variant_flowchart.png` |
| 9. Report | `09_report.py` | `reports/report_<timestamp>.pdf` |

---

## 🧠 Features

- **AI-generated executive summary**: GPT-4 writes a context-aware summary and recommendations based on your results.
- **Automated flowchart rendering**: Variant flow is visualized and embedded as a figure (PNG) in the report.
- **Comprehensive metrics**: All key QC, PRS, and regression statistics are included.
- **Professional, reproducible output**: Markdown and PDF reports, with all figures and metrics referenced.

---

## 🛠 Customization & Troubleshooting

- **QC thresholds**: Edit `config.yml`.
- **OpenAI provider**: Set your API key in `config.json`.
- **Flowchart rendering**: Requires Node.js and Mermaid CLI (`mmdc`). If you see errors, check your install and permissions.
- **Logs**: Check the `logs/` directory for detailed error messages.
- **Figures**: Extend or customize plots in `02_qc_plots.py`.

---

## 📑 Example report

See `docs/` for sample reports and figure outputs.

---

## 🤝 Contributing

PRs & issues welcome — style via **black** + **ruff**, tests via **pytest**.

---

## 📜 Citation

```
Ren F. GWAS-QC-AI-report: an end-to-end pipeline for QC, PRS and AI reporting.
https://github.com/francott7/GWAS-QC-AI-report (2025).
```

---

*Note: This is the first public version of the project. For Docker/Nextflow support, see future releases.*

---

## ⚙️ Parameters & Configuration

### Required parameters and files

- **Input VCF**: Path to your genotype file (default: `data/raw/ALL.chr22.phase3_shapeit2_mvncall_integrated_v5b.20130502.genotypes.vcf.gz`).
- **Effect sizes**: Path to GWAS effect sizes (default: `data/reference/effect_sizes.csv`).
- **Causal SNPs list**: For simulation (default: `data/processed/causal_snps.list`).
- **QC metrics**: Output of QC step (default: `results/01_qc/qc_metrics.json`).
- **PRS metrics**: Output of PRS calculation (default: `results/04_prs/prs_metrics.json`).

### Configuration files

- **`config.json`** (required for AI commentary)
  - Location: project root
  - Example:
    ```json
    { "openai_api_key": "sk-XXXXXXXXXXXXXXXX" }
    ```
- **`config.yml`** (optional, for QC/PRS thresholds)
  - Location: project root
  - Edit to set custom QC thresholds, e.g.:
    ```yaml
    call_rate_threshold: 0.95
    maf_threshold: 0.01
    hwe_threshold: 1e-6
    dosage_threshold: 0.1
    ```

### Where to edit parameters
- **Input/output paths**: Edit in `run_pipeline.sh` or pass as arguments to individual scripts.
- **QC/PRS thresholds**: Edit in `config.yml`.
- **OpenAI API key**: Set in `config.json`.
- **Other script-specific options**: See each script's `--help` for details.
